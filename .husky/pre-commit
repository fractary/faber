#!/bin/sh

# Auto-bump versions based on staged files
# This hook automatically bumps component versions when source files are staged

# Run version bump script
OUTPUT=$(node scripts/bump-versions.js --staged 2>&1)
EXIT_CODE=$?

# Show output to user so they know what happened
if [ -n "$OUTPUT" ]; then
  echo "$OUTPUT"
fi

# Exit if script failed
if [ $EXIT_CODE -ne 0 ]; then
  echo "Version bump failed. Use 'git commit --no-verify' to bypass."
  exit $EXIT_CODE
fi

# Stage any modified version files (only if they exist and were modified)
# Note: These paths are controlled and do not contain spaces
stage_modified_version_files() {
  for file in \
    "sdk/js/package.json" \
    "cli/package.json" \
    "cli/src/index.ts" \
    "mcp/server/package.json" \
    "mcp/server/src/index.ts" \
    "mcp/server/src/server.ts" \
    "plugins/faber/.claude-plugin/plugin.json" \
    "plugins/faber-article/.claude-plugin/plugin.json" \
    "plugins/faber-cloud/.claude-plugin/plugin.json"
  do
    # Check if file exists and has unstaged changes (git diff --quiet returns 1 if changes exist)
    if [ -f "$file" ] && ! git diff --quiet -- "$file" 2>/dev/null; then
      echo "Auto-staging: $file"
      git add -- "$file"
    fi
  done
}

stage_modified_version_files
