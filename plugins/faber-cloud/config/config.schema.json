{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/fractary/claude-plugins/main/plugins/faber-cloud/config/config.schema.json",
  "title": "faber-cloud Configuration Schema",
  "description": "JSON Schema for faber-cloud infrastructure plugin configuration",
  "type": "object",
  "required": ["version", "project", "handlers"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "format": "uri",
      "description": "JSON Schema reference for IDE validation"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$",
      "description": "Configuration version (e.g., '1.0', '2.0')"
    },
    "project": {
      "$ref": "#/definitions/project"
    },
    "handlers": {
      "$ref": "#/definitions/handlers"
    },
    "resource_naming": {
      "$ref": "#/definitions/resource_naming"
    },
    "environments": {
      "$ref": "#/definitions/environments"
    },
    "logging": {
      "$ref": "#/definitions/logging"
    },
    "workflows": {
      "type": "array",
      "minItems": 1,
      "description": "Array of workflow configurations or references",
      "items": {
        "$ref": "#/definitions/workflow"
      }
    },
    "hooks": {
      "$ref": "#/definitions/hooks"
    },
    "glue_execution": {
      "$ref": "#/definitions/glue_execution"
    }
  },
  "definitions": {
    "project": {
      "type": "object",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Project name (lowercase, hyphens allowed)"
        },
        "subsystem": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Subsystem or component name"
        },
        "organization": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Organization name"
        }
      }
    },
    "handlers": {
      "type": "object",
      "required": ["hosting", "iac"],
      "additionalProperties": false,
      "properties": {
        "hosting": {
          "$ref": "#/definitions/hosting_handler"
        },
        "iac": {
          "$ref": "#/definitions/iac_handler"
        }
      }
    },
    "hosting_handler": {
      "type": "object",
      "required": ["active"],
      "additionalProperties": false,
      "properties": {
        "active": {
          "type": "string",
          "enum": ["aws", "gcp", "azure"],
          "description": "Active hosting provider"
        },
        "aws": {
          "$ref": "#/definitions/aws_config"
        },
        "gcp": {
          "$ref": "#/definitions/gcp_config"
        },
        "azure": {
          "$ref": "#/definitions/azure_config"
        }
      }
    },
    "aws_config": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "account_id": {
          "type": "string",
          "pattern": "^\\d{12}$",
          "description": "AWS account ID (12 digits)"
        },
        "region": {
          "type": "string",
          "description": "AWS region (e.g., us-east-1)"
        },
        "profiles": {
          "type": "object",
          "description": "AWS CLI profiles for different environments",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "gcp_config": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "project_id": {
          "type": "string",
          "description": "GCP project ID"
        },
        "region": {
          "type": "string",
          "description": "GCP region (e.g., us-central1)"
        }
      }
    },
    "azure_config": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "subscription_id": {
          "type": "string",
          "description": "Azure subscription ID"
        },
        "resource_group": {
          "type": "string",
          "description": "Azure resource group"
        },
        "location": {
          "type": "string",
          "description": "Azure location (e.g., eastus)"
        }
      }
    },
    "iac_handler": {
      "type": "object",
      "required": ["active"],
      "additionalProperties": false,
      "properties": {
        "active": {
          "type": "string",
          "enum": ["terraform", "pulumi", "cdk"],
          "description": "Active IaC tool"
        },
        "terraform": {
          "$ref": "#/definitions/terraform_config"
        },
        "pulumi": {
          "$ref": "#/definitions/pulumi_config"
        }
      }
    },
    "terraform_config": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "directory": {
          "type": "string",
          "description": "Terraform working directory"
        },
        "var_file_pattern": {
          "type": "string",
          "description": "Variable file pattern (supports {environment} placeholder)"
        },
        "backend": {
          "$ref": "#/definitions/terraform_backend"
        }
      }
    },
    "terraform_backend": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["s3", "gcs", "azurerm", "local"],
          "description": "Backend type"
        },
        "bucket": {
          "type": "string",
          "description": "S3/GCS bucket name"
        },
        "key": {
          "type": "string",
          "description": "State file key/path (supports {project} placeholder)"
        }
      }
    },
    "pulumi_config": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "stack_pattern": {
          "type": "string",
          "description": "Stack naming pattern (supports placeholders)"
        }
      }
    },
    "resource_naming": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "pattern": {
          "type": "string",
          "description": "Resource naming pattern (supports {project}, {subsystem}, {environment}, {resource})"
        },
        "separator": {
          "type": "string",
          "description": "Separator character"
        }
      }
    },
    "environments": {
      "type": "object",
      "description": "Environment-specific configurations",
      "additionalProperties": {
        "$ref": "#/definitions/environment_config"
      }
    },
    "environment_config": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "auto_approve": {
          "type": "boolean",
          "description": "Auto-approve terraform apply (not recommended for production)"
        },
        "require_confirmation": {
          "type": "boolean",
          "description": "Require explicit confirmation before deployment"
        }
      }
    },
    "logging": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "backend": {
          "type": "string",
          "enum": ["s3", "local", "cloudwatch"],
          "description": "Logging backend"
        },
        "s3_bucket": {
          "type": "string",
          "description": "S3 bucket for logs"
        },
        "local_cache_days": {
          "type": "integer",
          "minimum": 0,
          "description": "Days to cache logs locally"
        }
      }
    },
    "workflow": {
      "oneOf": [
        {
          "$ref": "#/definitions/workflow_reference"
        },
        {
          "$ref": "#/definitions/workflow_inline"
        }
      ]
    },
    "workflow_reference": {
      "type": "object",
      "required": ["id", "file"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Workflow identifier (lowercase, hyphens allowed)"
        },
        "file": {
          "type": "string",
          "pattern": "^\\./workflows/[a-z][a-z0-9-]*\\.json$",
          "description": "Relative path to workflow JSON file (e.g., './workflows/infrastructure-deploy.json')"
        },
        "description": {
          "type": "string",
          "description": "Human-readable workflow description (optional override)"
        }
      }
    },
    "workflow_inline": {
      "type": "object",
      "description": "Inline workflow definition (for backward compatibility)",
      "additionalProperties": true
    },
    "hooks": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "pre-plan": {
          "$ref": "#/definitions/hook_array"
        },
        "post-plan": {
          "$ref": "#/definitions/hook_array"
        },
        "pre-deploy": {
          "$ref": "#/definitions/hook_array"
        },
        "post-deploy": {
          "$ref": "#/definitions/hook_array"
        },
        "pre-destroy": {
          "$ref": "#/definitions/hook_array"
        },
        "post-destroy": {
          "$ref": "#/definitions/hook_array"
        }
      }
    },
    "hook_array": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/hook"
      }
    },
    "hook": {
      "type": "object",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Hook name/identifier"
        },
        "type": {
          "type": "string",
          "enum": ["command", "skill"],
          "description": "Hook type (command or skill)"
        },
        "command": {
          "type": "string",
          "description": "Shell command to execute (for command type)"
        },
        "skill": {
          "type": "string",
          "description": "Skill to invoke (for skill type)"
        },
        "critical": {
          "type": "boolean",
          "description": "Whether hook failure should stop execution"
        },
        "required": {
          "type": "boolean",
          "description": "Whether hook is required (alias for critical)"
        },
        "timeout": {
          "type": "integer",
          "minimum": 1,
          "description": "Timeout in seconds"
        },
        "environments": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Environments where this hook should run"
        },
        "description": {
          "type": "string",
          "description": "Human-readable hook description"
        },
        "failureMode": {
          "type": "string",
          "enum": ["stop", "continue", "warn"],
          "description": "DEPRECATED: Use result_handling instead. How to handle hook failures"
        },
        "result_handling": {
          "$ref": "#/definitions/hook_result_handling"
        }
      }
    },
    "hook_result_handling": {
      "type": "object",
      "description": "Unified result handling for hooks (matches FABER workflow hooks)",
      "additionalProperties": false,
      "properties": {
        "on_success": {
          "type": "string",
          "enum": ["continue", "prompt"],
          "default": "continue",
          "description": "Action when hook succeeds"
        },
        "on_warning": {
          "type": "string",
          "enum": ["continue", "prompt", "stop"],
          "default": "continue",
          "description": "Action when hook has warnings"
        },
        "on_failure": {
          "type": "string",
          "enum": ["stop", "continue"],
          "default": "stop",
          "description": "Action when hook fails: 'stop' (default) or 'continue' for informational hooks"
        }
      }
    },
    "glue_execution": {
      "type": "object",
      "description": "AWS Glue job execution configuration for standardized argument handling",
      "additionalProperties": false,
      "properties": {
        "default_arguments": {
          "type": "object",
          "description": "Default arguments for all Glue jobs. Keys are EXACT argument names (case-sensitive), values support {placeholder} syntax.",
          "additionalProperties": {
            "type": "string"
          },
          "propertyNames": {
            "pattern": "^--[A-Za-z][A-Za-z0-9_-]*$",
            "description": "Argument names must start with -- and use consistent casing"
          }
        },
        "environment_arguments": {
          "type": "object",
          "description": "Environment-specific argument overrides",
          "additionalProperties": {
            "type": "object",
            "description": "Arguments for this environment",
            "additionalProperties": {
              "type": "string"
            }
          }
        },
        "job_arguments": {
          "type": "object",
          "description": "Job-specific argument overrides (keyed by job name pattern)",
          "additionalProperties": {
            "type": "object",
            "description": "Arguments for jobs matching this pattern",
            "additionalProperties": {
              "type": "string"
            }
          }
        },
        "argument_case": {
          "type": "string",
          "enum": ["UPPERCASE", "lowercase", "preserve"],
          "default": "UPPERCASE",
          "description": "Standard casing for argument names (UPPERCASE recommended for AWS Glue)"
        },
        "standard_arguments": {
          "type": "array",
          "description": "List of standard arguments that ALL Glue jobs should receive",
          "items": {
            "type": "object",
            "required": ["name", "source"],
            "additionalProperties": false,
            "properties": {
              "name": {
                "type": "string",
                "pattern": "^--[A-Za-z][A-Za-z0-9_-]*$",
                "description": "Argument name (e.g., --ENVIRONMENT, --VERSION)"
              },
              "source": {
                "type": "string",
                "enum": ["context", "config", "literal"],
                "description": "Where to get the value: context (workflow), config (this file), literal"
              },
              "context_key": {
                "type": "string",
                "description": "Key in workflow context (when source is 'context')"
              },
              "config_path": {
                "type": "string",
                "description": "JSON path in config (when source is 'config')"
              },
              "value": {
                "type": "string",
                "description": "Literal value (when source is 'literal')"
              },
              "required": {
                "type": "boolean",
                "default": true,
                "description": "Whether this argument is required"
              }
            }
          }
        },
        "retry_config": {
          "type": "object",
          "description": "Retry configuration for failed Glue jobs",
          "additionalProperties": false,
          "properties": {
            "max_attempts": {
              "type": "integer",
              "minimum": 1,
              "maximum": 10,
              "default": 3,
              "description": "Maximum retry attempts"
            },
            "backoff_seconds": {
              "type": "integer",
              "minimum": 1,
              "default": 30,
              "description": "Initial backoff between retries"
            },
            "backoff_multiplier": {
              "type": "number",
              "minimum": 1,
              "default": 2,
              "description": "Multiplier for exponential backoff"
            }
          }
        }
      }
    }
  }
}
