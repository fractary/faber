{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "FABER Workflow State Schema",
  "description": "Schema for tracking current workflow execution state",
  "type": "object",
  "required": ["target", "workflow_version", "status", "started_at"],
  "properties": {
    "target": {
      "type": "string",
      "description": "What is being worked on - artifact name, module, dataset, or description"
    },
    "work_id": {
      "type": ["string", "null"],
      "description": "Work item identifier (optional - provides issue context)"
    },
    "issue_number": {
      "type": "string",
      "description": "External issue number (e.g., GitHub issue #123)"
    },
    "workflow_version": {
      "type": "string",
      "description": "FABER workflow version (e.g., '2.0')"
    },
    "config_hash": {
      "type": "string",
      "description": "Hash of configuration file for consistency checking"
    },
    "status": {
      "type": "string",
      "enum": ["in_progress", "paused", "completed", "failed", "cancelled"],
      "description": "Overall workflow status"
    },
    "current_phase": {
      "type": "string",
      "enum": ["frame", "architect", "build", "evaluate", "release", "none"],
      "description": "Current phase being executed"
    },
    "current_step": {
      "type": "string",
      "description": "Current sub-step name within phase"
    },
    "current_step_id": {
      "type": "string",
      "pattern": "^(frame|architect|build|evaluate|release):[a-z][a-z0-9-]*$",
      "description": "Full step identifier in format 'phase:step-name' (e.g., 'build:implement')"
    },
    "additional_instructions": {
      "type": ["string", "null"],
      "description": "Custom prompt content provided via --prompt argument"
    },
    "started_at": {
      "type": "string",
      "format": "date-time",
      "description": "Workflow start timestamp (ISO 8601)"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "Last update timestamp (ISO 8601)"
    },
    "last_event_id": {
      "type": "integer",
      "minimum": 0,
      "description": "Most recent event ID for cross-validation with event log"
    },
    "completed_at": {
      "type": "string",
      "format": "date-time",
      "description": "Workflow completion timestamp (ISO 8601)"
    },
    "phases": {
      "type": "object",
      "description": "Phase-level state tracking",
      "properties": {
        "frame": {
          "$ref": "#/definitions/phase_state"
        },
        "architect": {
          "$ref": "#/definitions/phase_state"
        },
        "build": {
          "$ref": "#/definitions/phase_state"
        },
        "evaluate": {
          "$ref": "#/definitions/phase_state"
        },
        "release": {
          "$ref": "#/definitions/phase_state"
        }
      }
    },
    "pending_approvals": {
      "type": "array",
      "description": "Pending approval requests",
      "items": {
        "type": "object",
        "properties": {
          "phase": {
            "type": "string"
          },
          "reason": {
            "type": "string"
          },
          "requested_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    },
    "errors": {
      "type": "array",
      "description": "Errors encountered during workflow",
      "items": {
        "type": "object",
        "properties": {
          "phase": {
            "type": "string"
          },
          "step": {
            "type": "string"
          },
          "error": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    },
    "retries": {
      "type": "object",
      "description": "Retry tracking per phase",
      "additionalProperties": {
        "type": "integer"
      }
    },
    "artifacts": {
      "type": "object",
      "description": "Artifacts created during workflow",
      "properties": {
        "branch": {
          "type": "string"
        },
        "spec_path": {
          "type": "string"
        },
        "commits": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "pr_number": {
          "type": "string"
        },
        "pr_url": {
          "type": "string"
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional workflow metadata",
      "properties": {
        "autonomy_level": {
          "type": "string",
          "enum": ["dry-run", "assist", "guarded", "autonomous"]
        },
        "manager_skill": {
          "type": "string"
        },
        "director_skill": {
          "type": "string"
        }
      }
    },
    "sessions": {
      "type": "object",
      "description": "Session tracking for cross-session and cross-environment workflow execution",
      "properties": {
        "current_session_id": {
          "type": "string",
          "description": "Current Claude session identifier"
        },
        "session_history": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/session_record"
          },
          "description": "Historical record of all sessions that contributed to this workflow run"
        },
        "total_sessions": {
          "type": "integer",
          "description": "Total number of sessions (current + historical)"
        }
      }
    },
    "context_metadata": {
      "type": "object",
      "description": "Metadata about loaded context artifacts for debugging and optimization",
      "properties": {
        "last_artifact_reload": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of last artifact reload (ISO 8601)"
        },
        "reload_count": {
          "type": "integer",
          "description": "Total number of context reload operations"
        },
        "compaction_events": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/compaction_event"
          },
          "description": "Record of detected context compaction events"
        },
        "artifacts_in_context": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/artifact_load_record"
          },
          "description": "Currently loaded artifacts with load metadata"
        }
      }
    },
    "worktree": {
      "type": "object",
      "description": "Git worktree metadata (if workflow is running in a dedicated worktree)",
      "properties": {
        "path": {
          "type": "string",
          "description": "Absolute or relative path to the worktree directory"
        },
        "created_by": {
          "type": "string",
          "enum": ["fractary-faber", "manual", "unknown"],
          "description": "Who created this worktree (fractary-faber = auto-created, manual = user-created)"
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "When the worktree was created (ISO 8601)"
        },
        "auto_cleanup": {
          "type": "boolean",
          "description": "Whether this worktree should be automatically cleaned up after workflow completion"
        },
        "branch": {
          "type": "string",
          "description": "Git branch associated with this worktree"
        }
      },
      "required": ["path"]
    }
  },
  "definitions": {
    "phase_state": {
      "type": "object",
      "description": "State of a single workflow phase",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["pending", "in_progress", "completed", "failed", "skipped"],
          "description": "Phase status"
        },
        "started_at": {
          "type": "string",
          "format": "date-time",
          "description": "Phase start timestamp"
        },
        "completed_at": {
          "type": "string",
          "format": "date-time",
          "description": "Phase completion timestamp"
        },
        "current_step": {
          "type": "string",
          "description": "Current sub-step name within phase"
        },
        "current_step_id": {
          "type": "string",
          "description": "Full step identifier in format 'phase:step-name'"
        },
        "completed_steps": {
          "type": "array",
          "description": "List of completed sub-step names",
          "items": {
            "type": "string"
          }
        },
        "completed_step_ids": {
          "type": "array",
          "description": "List of completed step IDs in format 'phase:step-name'",
          "items": {
            "type": "string"
          }
        },
        "step_events": {
          "type": "object",
          "description": "Maps step IDs to their event IDs for cross-validation with immutable event log",
          "additionalProperties": {
            "type": "integer"
          }
        },
        "artifacts": {
          "type": "array",
          "description": "Artifacts created in this phase",
          "items": {
            "type": "string"
          }
        },
        "hooks_executed": {
          "type": "object",
          "description": "Hooks executed in this phase",
          "properties": {
            "pre": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "post": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        },
        "error": {
          "type": "string",
          "description": "Error message if phase failed"
        }
      }
    },
    "session_record": {
      "type": "object",
      "description": "Record of a single session's contribution to the workflow",
      "required": ["session_id", "started_at"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "Unique session identifier"
        },
        "started_at": {
          "type": "string",
          "format": "date-time",
          "description": "Session start timestamp (ISO 8601)"
        },
        "ended_at": {
          "type": "string",
          "format": "date-time",
          "description": "Session end timestamp (ISO 8601)"
        },
        "phases_completed": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["frame", "architect", "build", "evaluate", "release"]
          },
          "description": "Phases completed during this session"
        },
        "environment": {
          "type": "object",
          "description": "Environment metadata for cross-machine tracking",
          "properties": {
            "hostname": {
              "type": "string",
              "description": "Machine hostname"
            },
            "platform": {
              "type": "string",
              "description": "Operating system platform (e.g., 'linux', 'darwin', 'win32')"
            },
            "cwd": {
              "type": "string",
              "description": "Current working directory at session start"
            },
            "git_commit": {
              "type": "string",
              "description": "Git commit hash at session start"
            }
          }
        },
        "artifacts_loaded": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Artifact IDs loaded during this session"
        },
        "summary_path": {
          "type": "string",
          "description": "Path to session summary file (if exists)"
        }
      }
    },
    "compaction_event": {
      "type": "object",
      "description": "Record of a context compaction event",
      "required": ["detected_at"],
      "properties": {
        "detected_at": {
          "type": "string",
          "format": "date-time",
          "description": "When compaction was detected (ISO 8601)"
        },
        "phase": {
          "type": "string",
          "description": "Phase during which compaction occurred"
        },
        "step": {
          "type": "string",
          "description": "Step during which compaction occurred"
        },
        "action_taken": {
          "type": "string",
          "enum": ["reload_critical_artifacts", "none", "manual_trigger"],
          "description": "Action taken in response to compaction"
        }
      }
    },
    "artifact_load_record": {
      "type": "object",
      "description": "Record of an artifact load operation",
      "required": ["artifact_id", "loaded_at", "load_trigger"],
      "properties": {
        "artifact_id": {
          "type": "string",
          "description": "Unique artifact identifier from workflow config"
        },
        "loaded_at": {
          "type": "string",
          "format": "date-time",
          "description": "When artifact was loaded (ISO 8601)"
        },
        "load_trigger": {
          "type": "string",
          "enum": ["session_start", "phase_transition", "manual", "compaction_detected"],
          "description": "What triggered this load"
        },
        "source": {
          "type": "string",
          "description": "Source path or command used to load artifact"
        },
        "size_bytes": {
          "type": "integer",
          "description": "Size of loaded artifact in bytes (for optimization tracking)"
        }
      }
    }
  }
}
