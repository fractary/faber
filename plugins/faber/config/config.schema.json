{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/fractary/claude-plugins/main/plugins/faber/config/config.schema.json",
  "title": "FABER Configuration Schema",
  "description": "JSON Schema for FABER v2.3 workflow configuration with workflow inheritance and target definitions support",
  "type": "object",
  "required": ["schema_version", "workflows", "integrations"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "format": "uri",
      "description": "JSON Schema reference for IDE validation"
    },
    "schema_version": {
      "type": "string",
      "pattern": "^2\\.\\d+$",
      "description": "Configuration schema version (2.x)"
    },
    "default_workflow": {
      "type": "string",
      "description": "Default workflow ID to use when none specified. Can be namespaced (e.g., 'fractary-faber:default') or project-local (e.g., 'my-workflow'). If omitted, uses 'fractary-faber:default'."
    },
    "workflow_namespaces": {
      "$ref": "#/definitions/workflow_namespaces"
    },
    "targets": {
      "$ref": "#/definitions/targets"
    },
    "workflows": {
      "type": "array",
      "minItems": 0,
      "description": "Array of project-specific workflow configurations. These are in addition to namespaced workflows from plugins.",
      "items": {
        "$ref": "#/definitions/workflow"
      }
    },
    "workflow_inference": {
      "$ref": "#/definitions/workflow_inference"
    },
    "integrations": {
      "$ref": "#/definitions/integrations"
    },
    "logging": {
      "$ref": "#/definitions/logging"
    },
    "safety": {
      "$ref": "#/definitions/safety"
    },
    "backlog_management": {
      "type": "object",
      "description": "Backlog planning and prioritization settings",
      "additionalProperties": false,
      "properties": {
        "default_limit": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "default": 50,
          "description": "Default maximum issues to plan in one batch"
        },
        "default_order_by": {
          "type": "string",
          "enum": ["priority", "created", "updated", "none"],
          "default": "priority",
          "description": "Default ordering strategy for backlog planning"
        },
        "priority_config": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "label_prefix": {
              "type": "string",
              "default": "priority",
              "description": "Label prefix for priority extraction (e.g., 'priority' for 'priority-1' labels)"
            }
          }
        }
      }
    }
  },
  "definitions": {
    "targets": {
      "type": "object",
      "description": "Target configuration for work-ID-free planning. Allows defining named targets with metadata so the planner can work effectively without requiring a linked issue.",
      "additionalProperties": false,
      "properties": {
        "definitions": {
          "type": "array",
          "description": "Array of target definitions. Order matters for tie-breaking when patterns have equal specificity.",
          "items": {
            "$ref": "#/definitions/target_definition"
          }
        },
        "default_type": {
          "type": "string",
          "default": "file",
          "description": "Default target type when no pattern matches and require_match is false. Default: 'file'"
        },
        "require_match": {
          "type": "boolean",
          "default": false,
          "description": "If true, error when target doesn't match any pattern. If false, use default_type. Default: false"
        },
        "auto_create_issue": {
          "type": "boolean",
          "default": false,
          "description": "If true, automatically create an issue when target-based planning starts, providing full FABER integration. Default: false"
        }
      }
    },
    "target_definition": {
      "type": "object",
      "description": "A named target definition with glob pattern and metadata for the planner.",
      "required": ["name", "pattern", "type"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier for this target definition (lowercase, hyphens allowed)"
        },
        "pattern": {
          "type": "string",
          "description": "Glob pattern to match against the target input. Examples: 'ipeds/*', 'src/**/*.ts', 'plugins/*/', '{src/auth,src/session}/**'"
        },
        "type": {
          "type": "string",
          "enum": ["dataset", "code", "plugin", "docs", "config", "test", "infra"],
          "description": "Target category that determines plan structure and emphasis"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of what this target represents"
        },
        "metadata": {
          "type": "object",
          "description": "Arbitrary metadata passed to the planner. Use for project-specific context like entity_type, processing_type, languages, expected_artifacts, etc.",
          "additionalProperties": true
        },
        "workflow_override": {
          "type": "string",
          "description": "Optional workflow ID to use for this target type instead of the default workflow. Can be namespaced (e.g., 'fractary-faber:data-pipeline') or project-local."
        }
      }
    },
    "workflow_namespaces": {
      "type": "object",
      "description": "Workflow namespace resolution configuration. Defines where to find workflows for each namespace.",
      "additionalProperties": false,
      "properties": {
        "default_namespace": {
          "type": "string",
          "default": "project",
          "description": "Default namespace for unqualified workflow IDs. Default: 'project'"
        },
        "paths": {
          "type": "object",
          "description": "Custom namespace path mappings. Key is namespace, value is path pattern.",
          "additionalProperties": {
            "type": "string"
          },
          "examples": [
            {
              "project": ".fractary/plugins/faber/workflows",
              "fractary-faber": "~/.claude/plugins/marketplaces/fractary/plugins/faber/workflows"
            }
          ]
        }
      }
    },
    "workflow": {
      "oneOf": [
        {
          "$ref": "#/definitions/workflow_inline"
        },
        {
          "$ref": "#/definitions/workflow_reference"
        }
      ]
    },
    "workflow_inline": {
      "type": "object",
      "required": ["id", "phases", "autonomy"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Workflow identifier (lowercase, hyphens allowed)"
        },
        "description": {
          "type": "string",
          "description": "Human-readable workflow description"
        },
        "extends": {
          "type": "string",
          "description": "Parent workflow to extend. Use namespaced format: 'fractary-faber:default' for core workflows."
        },
        "skip_steps": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9-]*$"
          },
          "description": "Step IDs from parent workflows to skip"
        },
        "phases": {
          "$ref": "#/definitions/phases"
        },
        "hooks": {
          "$ref": "#/definitions/hooks",
          "deprecated": true,
          "description": "DEPRECATED: Use pre_steps and post_steps in phase definitions instead."
        },
        "autonomy": {
          "$ref": "#/definitions/autonomy"
        }
      }
    },
    "workflow_reference": {
      "type": "object",
      "required": ["id", "file"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Workflow identifier (lowercase, hyphens allowed)"
        },
        "file": {
          "type": "string",
          "pattern": "^\\./workflows/[a-z][a-z0-9-]*\\.json$",
          "description": "Relative path to workflow JSON file (e.g., './workflows/default.json')"
        },
        "description": {
          "type": "string",
          "description": "Human-readable workflow description (optional override, workflow file description takes precedence)"
        }
      }
    },
    "phases": {
      "type": "object",
      "required": ["frame", "architect", "build", "evaluate", "release"],
      "additionalProperties": false,
      "properties": {
        "frame": {
          "$ref": "#/definitions/phase"
        },
        "architect": {
          "$ref": "#/definitions/phase"
        },
        "build": {
          "$ref": "#/definitions/phase"
        },
        "evaluate": {
          "$ref": "#/definitions/phase_with_retries"
        },
        "release": {
          "$ref": "#/definitions/phase_with_approval"
        }
      }
    },
    "phase": {
      "type": "object",
      "required": ["enabled"],
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether this phase is enabled"
        },
        "description": {
          "type": "string",
          "description": "Phase description"
        },
        "pre_steps": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/step"
          },
          "description": "Steps to execute BEFORE child workflow steps"
        },
        "steps": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/step"
          },
          "description": "Main phase steps"
        },
        "post_steps": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/step"
          },
          "description": "Steps to execute AFTER child workflow steps"
        },
        "validation": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Validation checks for phase completion"
        }
      }
    },
    "phase_with_retries": {
      "allOf": [
        {
          "$ref": "#/definitions/phase"
        },
        {
          "type": "object",
          "properties": {
            "max_retries": {
              "type": "integer",
              "minimum": 0,
              "maximum": 10,
              "description": "Maximum retry attempts for this phase"
            }
          }
        }
      ]
    },
    "phase_with_approval": {
      "allOf": [
        {
          "$ref": "#/definitions/phase"
        },
        {
          "type": "object",
          "properties": {
            "require_approval": {
              "type": "boolean",
              "description": "Whether this phase requires explicit approval"
            }
          }
        }
      ]
    },
    "step": {
      "type": "object",
      "required": ["id"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique step identifier (must be unique across merged workflow)"
        },
        "name": {
          "type": "string",
          "description": "Human-readable display name for the step"
        },
        "description": {
          "type": "string",
          "description": "Human-readable step documentation (what this step does)"
        },
        "prompt": {
          "type": "string",
          "description": "Execution instruction for Claude when no skill is present, or to customize skill behavior."
        },
        "skill": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*:[a-z][a-z0-9-]*$",
          "description": "Skill reference in format plugin:skill-name"
        },
        "config": {
          "type": "object",
          "description": "Step-specific configuration"
        },
        "arguments": {
          "type": "object",
          "description": "Explicit arguments to pass to the step",
          "additionalProperties": {
            "type": "string"
          }
        },
        "result_handling": {
          "$ref": "#/definitions/step_result_handling"
        }
      },
      "anyOf": [
        {"required": ["description"]},
        {"required": ["prompt"]},
        {"required": ["skill"]}
      ]
    },
    "step_result_handling": {
      "type": "object",
      "description": "Defines behavior for step execution outcomes",
      "additionalProperties": false,
      "properties": {
        "on_success": {
          "type": "string",
          "enum": ["continue", "prompt"],
          "default": "continue"
        },
        "on_warning": {
          "type": "string",
          "enum": ["continue", "prompt", "stop"],
          "default": "continue"
        },
        "on_failure": {
          "const": "stop",
          "default": "stop",
          "description": "IMMUTABLE: Failure always stops"
        }
      }
    },
    "hooks": {
      "type": "object",
      "additionalProperties": false,
      "description": "DEPRECATED: Use pre_steps and post_steps in phase definitions instead.",
      "properties": {
        "pre_frame": {
          "$ref": "#/definitions/hook_array"
        },
        "post_frame": {
          "$ref": "#/definitions/hook_array"
        },
        "pre_architect": {
          "$ref": "#/definitions/hook_array"
        },
        "post_architect": {
          "$ref": "#/definitions/hook_array"
        },
        "pre_build": {
          "$ref": "#/definitions/hook_array"
        },
        "post_build": {
          "$ref": "#/definitions/hook_array"
        },
        "pre_evaluate": {
          "$ref": "#/definitions/hook_array"
        },
        "post_evaluate": {
          "$ref": "#/definitions/hook_array"
        },
        "pre_release": {
          "$ref": "#/definitions/hook_array"
        },
        "post_release": {
          "$ref": "#/definitions/hook_array"
        }
      }
    },
    "hook_array": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/hook"
      }
    },
    "hook": {
      "type": "object",
      "required": ["type", "name", "description"],
      "additionalProperties": false,
      "description": "DEPRECATED: Convert to pre_steps or post_steps instead.",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["document", "script", "skill"],
          "description": "Hook type"
        },
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Hook identifier"
        },
        "description": {
          "type": "string",
          "description": "Hook description"
        },
        "path": {
          "type": "string",
          "description": "Path to document or script (required for document and script types)"
        },
        "skill": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Skill name (required for skill type)"
        },
        "timeout": {
          "type": "integer",
          "minimum": 1,
          "maximum": 3600,
          "description": "Timeout in seconds (default: 300)"
        },
        "on_error": {
          "type": "string",
          "enum": ["continue", "abort", "retry"],
          "description": "DEPRECATED: Use result_handling instead.",
          "deprecated": true
        }
      },
      "oneOf": [
        {
          "properties": {
            "type": {
              "const": "document"
            }
          },
          "required": ["path"]
        },
        {
          "properties": {
            "type": {
              "const": "script"
            }
          },
          "required": ["path"]
        },
        {
          "properties": {
            "type": {
              "const": "skill"
            }
          },
          "required": ["skill"]
        }
      ]
    },
    "autonomy": {
      "type": "object",
      "required": ["level"],
      "additionalProperties": false,
      "properties": {
        "level": {
          "type": "string",
          "enum": ["dry-run", "assist", "guarded", "autonomous"],
          "description": "Workflow autonomy level"
        },
        "description": {
          "type": "string",
          "description": "Autonomy level description"
        },
        "pause_before_release": {
          "type": "boolean",
          "description": "Pause before release phase for approval"
        },
        "require_approval_for": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of actions requiring explicit approval"
        },
        "overrides": {
          "type": "object",
          "description": "Phase-specific autonomy overrides"
        }
      }
    },
    "integrations": {
      "type": "object",
      "required": ["work_plugin", "repo_plugin"],
      "additionalProperties": false,
      "properties": {
        "work_plugin": {
          "type": "string",
          "pattern": "^fractary-[a-z][a-z0-9-]*$",
          "description": "Work tracking plugin name"
        },
        "repo_plugin": {
          "type": "string",
          "pattern": "^fractary-[a-z][a-z0-9-]*$",
          "description": "Repository plugin name"
        },
        "spec_plugin": {
          "type": "string",
          "pattern": "^fractary-[a-z][a-z0-9-]*$",
          "description": "Specification plugin name"
        },
        "logs_plugin": {
          "type": "string",
          "pattern": "^fractary-[a-z][a-z0-9-]*$",
          "description": "Logging plugin name"
        },
        "docs_plugin": {
          "type": "string",
          "pattern": "^fractary-[a-z][a-z0-9-]*$",
          "description": "Documentation plugin name"
        }
      }
    },
    "logging": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "use_logs_plugin": {
          "type": "boolean",
          "description": "Use fractary-logs plugin for workflow logging"
        },
        "log_type": {
          "type": "string",
          "description": "Log type identifier"
        },
        "log_level": {
          "type": "string",
          "enum": ["debug", "info", "warn", "error"],
          "description": "Logging level"
        },
        "log_phases": {
          "type": "boolean",
          "description": "Log phase transitions"
        },
        "log_sub_steps": {
          "type": "boolean",
          "description": "Log individual step execution"
        }
      }
    },
    "workflow_inference": {
      "type": "object",
      "description": "Multi-tier workflow selection strategy based on labels and work type classification",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable intelligent workflow selection. If false, always uses default_workflow."
        },
        "label_mapping": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Map issue labels to workflow IDs. Example: {\"bug\": \"fractary-faber:bug\", \"feature\": \"fractary-faber:feature\"}"
        },
        "fallback_to_classification": {
          "type": "boolean",
          "default": true,
          "description": "When no label matches, classify work type and use work_type_mapping. If false, uses default_workflow."
        },
        "work_type_mapping": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Map work types (bug, feature, patch, chore, etc.) to workflow IDs. Used when fallback_to_classification is true."
        }
      }
    },
    "safety": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "protected_paths": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Glob patterns for protected paths"
        },
        "require_confirm_for": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Actions requiring confirmation"
        }
      }
    }
  }
}
