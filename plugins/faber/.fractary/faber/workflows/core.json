{
  "$schema": "../workflow.schema.json",
  "id": "core",
  "description": "Core FABER workflow primitives - issue management, branching, PR lifecycle. Meant to be extended by other workflows.",
  "phases": {
    "frame": {
      "enabled": true,
      "description": "Fetch work item and setup branch",
      "pre_steps": [
        {
          "id": "auto-reload-context",
          "name": "Reload Context",
          "description": "Automatically reload critical artifacts for session continuity",
          "prompt": "/fractary-faber:session-load"
        },
        {
          "id": "core-fetch-issue",
          "name": "Fetch Issue",
          "description": "Fetch existing issue. Reads referenced docs and existing commits.",
          "prompt": "/fractary-work:issue-fetch --work-id {work_id}"
        }
      ],
      "steps": [],
      "post_steps": [
        {
          "id": "core-commit-and-push-frame",
          "name": "Commit and Push Changes",
          "description": "Ensure all frame changes are committed and pushed",
          "prompt": "/fractary-repo:commit-push"
        }, 
        {
          "id": "frame-issue-comment",
          "name": "Add GitHub Issue Comment for Frame Phase",
          "description": "Share results of the frame phase.",
          "prompt": "/fractary-work:issue-comment --work-id {work_id} --context \"Add comment updating status of the issue as frame phase completed and reference created workflow plan with link to its location in the repository. Please also reference the issue template that was used to create the issue and give a summary of the steps that will be taken by the workflow plan as a bulleted list organized by phase. Please also suggest the next step to take including the exact command to run to perform that next step.\""
        }
      ]
    },
    "architect": {
      "enabled": true,
      "description": "Design and plan - extend this phase in child workflows",
      "pre_steps": [],
      "steps": [],
      "post_steps": [
        {
          "id": "core-commit-and-push-architect",
          "name": "Commit and Push Changes",
          "description": "Ensure all build changes are committed and pushed",
          "prompt": "/fractary-repo:commit-push"
        }, 
        {
          "id": "architect-issue-comment",
          "name": "Add GitHub Issue Comment for Architect Phase",
          "description": "Share results of the architect phase.",
          "prompt": "/fractary-work:issue-comment --work-id {work_id} --context \"Add comment updating status of the issue as architect phase completed and give a summary of the steps that were taken during the architect phase and the results, referencing any artifacts that were created during the phase. Please also suggest the next step to take including the exact command to run to perform that next step.\""
        }
      ]
    },
    "build": {
      "enabled": true,
      "description": "Implementation - extend this phase in child workflows",
      "pre_steps": [],
      "steps": [],
      "post_steps": [
        {
          "id": "core-commit-and-push-build",
          "name": "Commit and Push Changes",
          "description": "Ensure all build changes are committed and pushed",
          "prompt": "/fractary-repo:commit-push"
        }, 
        {
          "id": "build-issue-comment",
          "name": "Add GitHub Issue Comment for Build Phase",
          "description": "Share results of the build phase.",
          "prompt": "/fractary-work:issue-comment --work-id {work_id} --context \"Add comment updating status of the issue as build phase completed and give a summary of the steps that were taken during the build phase and the results, referencing any artifacts that were created during the phase. Please also suggest the next step to take including the exact command to run to perform that next step.\""
        }
      ]
    },
    "evaluate": {
      "enabled": true,
      "description": "Review implementation and create PR",
      "pre_steps": [],
      "steps": [],
      "post_steps": [
        {
          "id": "core-create-pr",
          "name": "Create Pull Request",
          "description": "Create PR for the implementation (skips if PR already exists). Links to issue for auto-close on merge.",
          "prompt": "/fractary-repo:commit-push-pr"
        },
        {
          "id": "core-review-pr-checks",
          "name": "Review PR CI Checks",
          "description": "Wait for and review CI/CD pipeline results",
          "prompt": "/fractary-repo:pr-review --wait-for-ci"
        }, 
        {
          "id": "evaluate-issue-comment",
          "name": "Add GitHub Issue Comment for Evaluate Phase",
          "description": "Share results of evaluate phase.",
          "prompt": "/fractary-work:issue-comment --work-id {work_id} --context \"Add comment updating status of the issue as evaluate phase completed and give a summary of the steps that were taken during the evaluate phase and the results, referencing any artifacts that were created during the phase. Please also suggest the next step to take including the exact command to run to perform that next step.\""
        }
      ]
    },
    "release": {
      "enabled": true,
      "description": "Merge PR and complete workflow",
      "require_approval": true,
      "pre_steps": [],
      "steps": [],
      "post_steps": [
        {
          "id": "core-merge-pr",
          "name": "Merge Pull Request",
          "description": "Merge the PR and delete branch",
          "prompt": "/fractary-repo:pr-merge {pr_number} --delete-branch"
        },
        {
          "id": "core-cleanup-worktree",
          "name": "Cleanup Worktree",
          "description": "Remove auto-created worktree if workflow was run in dedicated worktree",
          "prompt": "Check if this workflow created a worktree (state.worktree.created_by === 'fractary-faber'). If yes, ask user if they want to remove it using /fractary-repo:worktree-remove and update .fractary/faber/worktrees.json tracking.",
          "guards": {
            "skip_if": "!state.worktree || state.worktree.created_by !== 'fractary-faber'"
          }
        }, 
        {
          "id": "release-issue-comment",
          "name": "Add GitHub Issue Comment for Release Phase",
          "description": "Share results of completing release phase.",
          "prompt": "/fractary-work:issue-comment --work-id {work_id} --context \"Add comment updating status of the issue as release phase completed and give a summary of the steps that were taken during the release phase and the results, referencing any artifacts that were created during the phase. Please also suggest the next step to take including the exact command to run to perform that next step.\""
        }
      ]
    }
  },
  "autonomy": {
    "level": "guarded",
    "description": "Pauses before release for approval - recommended for production",
    "require_approval_for": ["release"]
  },
  "critical_artifacts": {
    "always_load": [
      {
        "id": "workflow-state",
        "type": "json",
        "path": ".fractary/faber/runs/{plan_id}/state-{run_suffix}.json",
        "description": "Current workflow state file - essential for continuation",
        "required": true,
        "reload_triggers": ["session_start", "manual"]
      },
      {
        "id": "orchestration-protocol",
        "type": "markdown",
        "path": "plugins/faber/docs/workflow-orchestration-protocol.md",
        "description": "Workflow execution protocol - defines how to execute steps",
        "required": true,
        "reload_triggers": ["session_start"]
      }
    ],
    "conditional_load": [
      {
        "id": "issue-context",
        "type": "work_plugin",
        "command": "/fractary-work:issue-fetch {work_id}",
        "description": "Issue details and context",
        "required": false,
        "condition": "state.work_id != null",
        "reload_triggers": ["session_start"]
      }
    ]
  }
}
