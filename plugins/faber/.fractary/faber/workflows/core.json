{
  "$schema": "../workflow.schema.json",
  "id": "core",
  "description": "Core FABER workflow primitives - issue management, branching, PR lifecycle. Meant to be extended by other workflows.",
  "phases": {
    "frame": {
      "enabled": true,
      "description": "Fetch work item and setup branch",
      "pre_steps": [
        {
          "id": "auto-reload-context",
          "name": "Reload Context",
          "description": "Automatically reload critical artifacts for session continuity",
          "prompt": "/fractary-faber:session-load"
        },
        {
          "id": "core-fetch-issue",
          "name": "Fetch Issue",
          "description": "Fetch existing issue. Reads referenced docs and existing commits.",
          "prompt": "/fractary-work:issue-fetch --work-id {work_id}"
        }
      ],
      "steps": [],
      "post_steps": [
        {
          "id": "frame-commit-and-push",
          "name": "Commit and Push Changes",
          "description": "Ensure all frame changes are committed and pushed (which will also create a branch to push to).",
          "prompt": "/fractary-repo:commit-push --work-id {work_id}"
        }, 
        {
          "id": "frame-issue-comment-complete",
          "name": "Add GitHub Issue Comment to Complete Frame Phase",
          "description": "Summarize completion of frame phase and propose next steps.",
          "prompt": "/fractary-work:issue-comment --work-id {work_id} --context \"Add a comment updating status of the issue as frame phase completed and suggesting next steps to take including the exact command to run to perform that next step.\""
        }
      ]
    },
    "architect": {
      "enabled": true,
      "description": "Design and plan - extend this phase in child workflows",
      "pre_steps": [],
      "steps": [],
      "post_steps": [
        {
          "id": "architect-commit-and-push",
          "name": "Commit and Push Changes",
          "description": "Ensure all architect changes are committed and pushed",
          "prompt": "/fractary-repo:commit-push --work-id {work_id}"
        }, 
        {
          "id": "architect-issue-comment-complete",
          "name": "Add GitHub Issue Comment to Complete Architect Phase",
          "description": "Summarize completion of architect phase and propose next steps.",
          "prompt": "/fractary-work:issue-comment --work-id {work_id} --context \"Add a comment updating status of the issue as architect phase completed and suggesting next steps to take including the exact command to run to perform that next step.\""
        }
      ]
    },
    "build": {
      "enabled": true,
      "description": "Implementation - extend this phase in child workflows",
      "pre_steps": [],
      "steps": [],
      "post_steps": [
        {
          "id": "build-create-pr",
          "name": "Create Pull Request",
          "description": "Create PR for the implementation (skips if PR already exists). Links to issue for auto-close on merge.",
          "prompt": "/fractary-repo:commit-push-pr --work-id {work_id}"
        },  
        {
          "id": "build-issue-comment-complete",
          "name": "Add GitHub Issue Comment to Complete Build Phase",
          "description": "Summarize completion of build phase and propose next steps.",
          "prompt": "/fractary-work:issue-comment --work-id {work_id} --context \"Add a comment updating status of the issue as build phase completed and suggesting next steps to take including the exact command to run to perform that next step.\""
        }
      ]
    },
    "evaluate": {
      "enabled": true,
      "description": "Review implementation and create PR",
      "pre_steps": [
        {
          "id": "evaluate-pr-review",
          "name": "Review PR CI Checks",
          "description": "Wait for and review CI/CD pipeline results",
          "prompt": "/fractary-repo:pr-review {pr_id} --wait-for-ci --auto-fix"
        }, 
        {
          "id": "evaluate-pr-merge-test",
          "name": "Merge PR to Test Branch",
          "description": "Merge the pull request to the test branch.",
          "prompt": "/fractary-repo:pr-merge {pr_id} --to-branch test"
        }
      ],
      "steps": [],
      "post_steps": [
        {
          "id": "evaluate-codex-sync-test",
          "name": "Sync to Codex (Test)",
          "description": "Push project documentation to codex",
          "prompt": "/fractary-codex:sync-project --work-id {work_id} --to-codex --env test"
        }, 
        {
          "id": "evaluate-issue-comment-complete",
          "name": "Add GitHub Issue Comment to Complete Evaluate Phase",
          "description": "Summarize completion of evaluate phase and propose next steps.",
          "prompt": "/fractary-work:issue-comment --work-id {work_id} --context \"Add a comment updating status of the issue as evaluate phase completed and suggesting next steps to take including the exact command to run to perform that next step.\""
        }
      ]
    },
    "release": {
      "enabled": true,
      "description": "Merge PR and complete workflow",
      "require_approval": true,
      "pre_steps": [
        {
          "id": "release-create-pr",
          "name": "Create Pull Request for Release",
          "description": "Create PR for release to production environment.",
          "prompt": "/fractary-repo:commit-push-pr --work-id {work_id} --to-branch main"
        },
        {
          "id": "release-pr-merge-prod",
          "name": "Merge PR to Main Branch",
          "description": "Merge the pull request to the main branch.",
          "prompt": "/fractary-repo:pr-merge {pr_id} --to-branch main"
        }
      ],
      "steps": [],
      "post_steps": [
        {
          "id": "release-codex-sync-prod",
          "step_action": "codex-sync-prod",
          "step_type": "codex",
          "name": "Sync to Codex (Production)",
          "description": "Push project documentation to codex",
          "prompt": "/fractary-codex:sync-project --work-id {work_id} --to-codex --environment prod"
        }, 
        {
          "id": "release-issue-comment-complete",
          "name": "Add GitHub Issue Comment to Complete Release Phase",
          "description": "Summarize completion of release phase and propose next steps.",
          "prompt": "/fractary-work:issue-comment --work-id {work_id} --context \"Add a comment updating status of the issue as release phase completed and suggesting next steps to take including the exact command to run to perform that next step. Please also confirm the status of the Codex Sync step and list the files that were updated.\""
        }
      ]
    }
  },
  "autonomy": {
    "level": "guarded",
    "description": "Pauses before release for approval - recommended for production",
    "require_approval_for": ["release-pr-merge-prod", "release-deploy-apply-prod"]
  },
  "critical_artifacts": {
    "always_load": [
      {
        "id": "workflow-state",
        "type": "json",
        "path": ".fractary/faber/runs/{plan_id}/state-{run_suffix}.json",
        "description": "Current workflow state file - essential for continuation",
        "required": true,
        "reload_triggers": ["session_start", "manual"]
      },
      {
        "id": "orchestration-protocol",
        "type": "markdown",
        "path": "plugins/faber/docs/workflow-orchestration-protocol.md",
        "description": "Workflow execution protocol - defines how to execute steps",
        "required": true,
        "reload_triggers": ["session_start"]
      }
    ],
    "conditional_load": [
      {
        "id": "issue-context",
        "type": "work_plugin",
        "command": "/fractary-work:issue-fetch --work-id {work_id}",
        "description": "Issue details and context",
        "required": false,
        "condition": "state.work_id != null",
        "reload_triggers": ["session_start"]
      }
    ]
  }
}
